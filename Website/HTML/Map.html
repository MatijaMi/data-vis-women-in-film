<!DOCTYPE html>

<html lang="en" style="height: 100%">

<head>
    <title>WFPP</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../CSS/baseStyle.css">
    <link rel="stylesheet" href="../CSS/map.css">
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://github.com/typeiii/jquery-csv"></script>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>

<body>

    <!-- Header -->
    <div class="header" id="header">
        <a href="/index.html">Home</a>
        <a href="Map.html">Map</a>
        <a href="Viewer.html">Viewer</a>
        <a href="">Extra</a>
        <a href="">Gallery</a>
        <a href="">About</a>
    </div>

    <!-- Sidepanel -->
    <div class="sidepanel_panel">
        <div id="sidepanel_holder" hidden="true">
            <label class="sidepanel_headline" id="country_name_label"></label>

            <br><br>

            <label class="sidepanel_entry">Pioneers: </label>
            <label class="sidepanel_entry" id="pioneers_count_label"></label><br>

            <label class="sidepanel_entry">Different Jobs: </label>
            <label class="sidepanel_entry" id="pioneers_jobs_label"></label><br>

            <label class="sidepanel_entry">Connections: </label>
            <label class="sidepanel_entry" id="pioneers_connections_label"></label>

            <br><br>

            <label class="sidepanel_entry">Example Pioneer: </label><br>
            <label class="sidepanel_entry" id="pioneers_ex_name"></label>

            <br><br>

            <img class="sidepanel_image" id="pioneers_ex_image"
                src="https://wfpp.columbia.edu/wp-content/uploads/2018/05/adaalineurban.jpg"
                onerror="image_load_error()"><br><br>

            <button class="sidepanel_button" id="pioneers_ex_button">Read more</label>

        </div>
    </div>

    <!-- Settings -->
    <div class="settings_panel">
        <label class="settings_headline">Settings</label>

        <br><br>

        <label class="settins_entry">From: </label>
        <input type="number" id="settings_min_year" min="1830" max="1910" value="1830">

        <label class="settins_entry">To: </label>
        <input type="number" id="settings_max_year" min="1900" max="2020" value="2020"><br><br>

        <input type="checkbox" id="settings_checkbox_unknown" checked>
        <label for="settings_checkbox_unknown"> Include Pioneers with unknown dates</label>

        <br><br>

        <button class="settings_button" id="settings_button" onclick="settings_button_onclick()">Apply</label>

    </div>


    <!-- Map Object -->
    <div class="map_body" id="map_body"></div>

    <!-- Map -->
    <script src="../JS/map.js"></script>
    <script>

        //Read cookies
        var temp_min_year = getCookie("map_settings_min_year");
        var temp_max_year = getCookie("map_settings_max_year");
        var temp_unknown = getCookie("map_settings_checkbox_unknown");

        //Apply cookies
        if (temp_min_year.length > 0) document.getElementById('settings_min_year').value = temp_min_year;
        if (temp_max_year.length > 0) document.getElementById('settings_max_year').value = temp_max_year;
        if (temp_unknown == "false") document.getElementById('settings_checkbox_unknown').checked = false;

        //Check settings values
        if (document.getElementById('settings_min_year').value < document.getElementById('settings_min_year').min) document.getElementById('settings_min_year').value = document.getElementById('settings_min_year').min;
        if (document.getElementById('settings_min_year').value > document.getElementById('settings_min_year').max) document.getElementById('settings_min_year').value = document.getElementById('settings_min_year').max;
        if (document.getElementById('settings_max_year').value < document.getElementById('settings_max_year').min) document.getElementById('settings_max_year').value = document.getElementById('settings_max_year').min;
        if (document.getElementById('settings_max_year').value > document.getElementById('settings_max_year').max) document.getElementById('settings_max_year').value = document.getElementById('settings_max_year').max;
        if (document.getElementById('settings_max_year').value < document.getElementById('settings_min_year').value) document.getElementById('settings_max_year').value = document.getElementById('settings_min_year').value;

        // Dimensions
        var width = window.innerWidth;
        var height = window.innerHeight;

        //List of all countries
        let countries = createAllCountries();

        // Append the svg object to the body of the page
        var svg = d3.select("#map_body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)

        // Map and projection
        var path = d3.geoPath();
        var projection = d3.geoMercator()
            .scale(245)
            .center([0, 0])
            .translate([width / 2, height / 1.5]);

        // Data and color scale
        var data = d3.map();
        var colorScale = d3.scaleThreshold()
            .domain([1, 2, 5, 15, 50, 100])
            .range(d3.schemeBlues[6]);

        // Load external data and boot
        d3.queue()
            .defer(d3.json, "../Data/world_map.geojson")
            .defer(d3.csv, "../Data/complete_data.csv", function (row) {

                //Calculations for each row
                //Use settings
                if (!document.getElementById('settings_checkbox_unknown').checked) {
                    if (row.YOB.length == 0 || row.YOD.length == 0) return;
                }
                if (row.YOB < document.getElementById('settings_min_year').value) return;
                if (row.YOD > document.getElementById('settings_max_year').value) return;

                //Population
                var curr_countries_names = row.worked_in.split("|");
                for (i = 0; i < curr_countries_names.length; i++) {
                    var curr_country_name = curr_countries_names[i];
                    var curr_country = findObjectByKey(countries, "country_name", curr_country_name);

                    if (curr_country != null) {
                        var row_worked_as = row.worked_as.split("|");
                        row_worked_as.forEach(function (part, index) {
                            this[index] = this[index].split(">").pop();
                        }, row_worked_as);

                        curr_country.country_pioneers.push(new Pioneer(row.name, row.image_url, row.link, curr_countries_names, row_worked_as));

                        //Connections
                        for (j = 0; j < curr_countries_names.length; j++) {
                            var connection_name = curr_countries_names[j];
                            if (curr_country_name !== connection_name) {
                                if (curr_country.country_connected_countries.findIndex(x => x == connection_name) === -1) {
                                    curr_country.country_connected_countries.push(connection_name);
                                }

                            }
                        }
                    }
                }

                //Different Jobs
                for (i = 0; i < countries.length; i++) {
                    var curr_country = countries[i];
                    var jobs = []
                    for (j = 0; j < curr_country.country_pioneers.length; j++) {
                        var curr_pioneer = curr_country.country_pioneers[j];
                        for (u = 0; u < curr_country.country_pioneers.length; u++) {
                            var curr_job = curr_pioneer.pioneer_worked_as[u]
                            if (typeof curr_job !== "undefined") {
                                jobs.push(curr_job);
                            }
                        }
                    }
                    curr_country.country_jobs = uniq(jobs);
                }
            })
            .await(ready);

        function ready(error, map_data, complete_data) {

            //Mouse Over
            let mouseOver = function (d) {

                //Check if country is used
                if (findObjectByKey(countries, "country_code", d.id) == null) return;
                if (findObjectByKey(countries, "country_code", d.id).country_pioneers.length == 0) return;

                //Mouser Over Animation
                d3.selectAll(".Country")
                    .transition()
                    .duration(200)
                    .style("opacity", .8)
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("opacity", 1)
                    .style("stroke", "black")

            }

            let mouseLeave = function (d) {

                //Mouser Leave Animation
                d3.selectAll(".Country")
                    .transition()
                    .duration(200)
                    .style("opacity", 1)
                d3.select(this)
                    .transition()
                    .duration(0)
                    .style("stroke", "transparent")
            }

            let mouseClick = function (d) {

                //Get current country
                var curr_country = findObjectByKey(countries, "country_code", d.id);

                //Check if country is used                
                if (findObjectByKey(countries, "country_code", d.id) == null) return;
                if (findObjectByKey(countries, "country_code", d.id).country_pioneers.length == 0) return;

                //Remove old links
                svg.selectAll(".Link")
                    .remove()

                //Sidebar                
                document.getElementById('country_name_label').innerHTML = curr_country.country_name;
                document.getElementById('pioneers_count_label').innerHTML = curr_country.country_pioneers.length;
                document.getElementById('pioneers_jobs_label').innerHTML = curr_country.country_jobs.length;
                document.getElementById('pioneers_connections_label').innerHTML = curr_country.country_connected_countries.length;

                var example_pioneer = curr_country.country_pioneers[Math.floor(Math.random() * curr_country.country_pioneers.length)];

                document.getElementById('pioneers_ex_name').innerHTML = example_pioneer.pioneer_name;
                document.getElementById('pioneers_ex_image').src = "";
                document.getElementById('pioneers_ex_image').src = example_pioneer.pioneer_image;
                document.getElementById('pioneers_ex_button').onclick = function () { window.open(example_pioneer.pioneer_link) };
                document.getElementById('sidepanel_holder').hidden = false;

                //Calculate connections
                var link = []
                for (var i = 0; i < curr_country.country_connected_countries.length; i++) {
                    var connected_country = findObjectByKey(countries, "country_name", curr_country.country_connected_countries[i]);

                    source = [curr_country.country_long, curr_country.country_lat]
                    target = [connected_country.country_long, connected_country.country_lat]
                    topush = { type: "LineString", coordinates: [source, target] }
                    link.push(topush)
                }

                // Add the path
                svg.selectAll("myPath")
                    .data(link)
                    .enter()
                    .append("path")
                    .attr("d", function (d) { return path(d) })
                    .attr("class", function (d) { return "Link" })
                    .style("pointer-events", "none")
                    .style("fill", "none")
                    .style("stroke", "#00d4db")
                    .style("stroke-width", 4)
                    .style("opacity", 0)
                    .transition()
                    .duration(500)
                    .style("opacity", 1)
            }

            //Draw the map
            svg.append("g")
                .selectAll("path")
                .data(map_data.features)
                .enter()
                .append("path")

                //Draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )

                .attr("class", function (d) { return "Country" })
                .style("opacity", .8)
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave)
                .on("click", mouseClick)

                //Set the color of each country
                .attr("fill", function (d) {
                    if (findObjectByKey(countries, "country_code", d.id) != null) {
                        return colorScale(findObjectByKey(countries, "country_code", d.id).country_pioneers.length);
                    }
                    else return colorScale(0);

                });
        }


    </script>

    <!-- Footer -->
    <div class="footer">

    </div>

</body>

</html>