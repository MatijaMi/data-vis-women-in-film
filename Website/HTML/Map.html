<!DOCTYPE html>

<html lang="en" style="height: 100%">

<head>
    <title>WFPP</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../CSS/baseStyle.css">
    <link rel="sidepanel_css" href="../CSS/map_sidepanel.css">
    <script type="module" src="../JS/generalBehaviour.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://github.com/typeiii/jquery-csv"></script>

</head>

<body>

    <!-- Header -->
    <div class="header" id="header">
        <a href="/index.html">Home</a>
        <a href="Map.html">Map</a>
        <a href="Viewer.html">Viewer</a>
        <a href="">Extra</a>
        <a href="">Gallery</a>
        <a href="">About</a>
    </div>

    <!-- Sidepanel -->
    <div id="sidepanel_main" class="sidenav">
        <label class="sidepanel_headline" id="country_name_label"></label>

        <br><br>

        <label class="sidepanel_entry">Pinoeers: </label>
        <label class="sidepanel_entry" id="pioneers_count_label"></label>
    </div>

    <!-- Settings -->
    <div class="settings" id="settings_panel"></div>

    <!-- Map Object -->
    <div class="map" id="map_panel"></div>

    <!-- Map -->
    <script>

        // Dimensions
        var width = window.innerWidth;
        var height = window.innerHeight;

        // Add a <div> container for the tooltip, which is hidden by default.
        var tooltip = d3.select("#map_panel")
            .append("div")
            .attr("class", "tooltip");

        // Append the svg object to the body of the page
        var svg = d3.select("#map_panel")
            .append("svg")
            .attr("width", width)
            .attr("height", height)

        // Map and projection
        var path = d3.geoPath();
        var projection = d3.geoMercator()
            .scale(245)
            .center([0, 0])
            .translate([width / 2, height / 1.5]);

        // Data and color scale
        var data = d3.map();
        var colorScale = d3.scaleThreshold()
            .domain([1, 2, 5, 15, 50, 100])
            .range(d3.schemeBlues[6]);

        // Load external data and boot
        d3.queue()
            .defer(d3.json, "../Data/world_map.geojson")
            .defer(d3.csv, "../Data/world_population.csv", function (d) { data.set(d.code, +d.pop); })
            .defer(d3.csv, "../Data/world_population.csv")
            .defer(d3.csv, "../Data/connections.csv")
            .await(ready);

        //Forces page to automaticly reloade margin of header
        scroll(0, 100)
        scroll(0, 0)

        function ready(error, map_data, population_data, countries_data, connection_data) {

            //Mouse Over
            let mouseOver = function (d) {

                //Check if country is used
                var country_name = "";
                countries_data.forEach(function (row) {
                    if (row.code == d.id) country_name = row.name;
                });

                //Do not mouse over if country is not used
                if (country_name == "") return;

                //Animation
                d3.selectAll(".Country")
                    .transition()
                    .duration(200)
                    .style("opacity", .8)
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("opacity", 1)
                    .style("stroke", "black")

                //Sidebar                
                document.getElementById('country_name_label').innerHTML = country_name;
                document.getElementById('pioneers_count_label').innerHTML = data.get(d.id) || 0;
                document.getElementById('sidepanel_main').hidden = false;            

                //Calculate connections
                var link = []
                connection_data.forEach(function (row) {
                    if (row.country1 == country_name || row.country2 == country_name) {
                        source = [+row.long1, +row.lat1]
                        target = [+row.long2, +row.lat2]
                        topush = { type: "LineString", coordinates: [source, target] }
                        link.push(topush)
                    }
                })

                // Add the path
                svg.selectAll("myPath")
                    .data(link)
                    .enter()
                    .append("path")
                    .attr("d", function (d) { return path(d) })
                    .attr("class", function (d) { return "Link" })
                    .style("pointer-events", "none")
                    .style("fill", "none")
                    .style("stroke", "#00d4db")
                    .style("stroke-width", 4)
                    .style("opacity", 0)
                    .transition()
                    .duration(500)
                    .style("opacity", 1)

            }

            let mouseLeave = function (d) {

                //Animation
                d3.selectAll(".Country")
                    .transition()
                    .duration(0)
                    .style("opacity", 1)
                d3.select(this)
                    .transition()
                    .duration(0)
                    .style("stroke", "transparent")

                //Tooltip
                tooltip.classed('hidden', true)
                    .html("");

                //Remove Links
                svg.selectAll(".Link")
                    .remove()

                //Sidebar                
                document.getElementById('sidepanel_main').hidden = true;
            }


            // Draw the map
            svg.append("g")
                .selectAll("path")
                .data(map_data.features)
                .enter()
                .append("path")

                // draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )

                .attr("class", function (d) { return "Country" })
                .style("opacity", .8)
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave)

                // set the color of each country
                .attr("fill", function (d) {
                    d.total = data.get(d.id) || 0;
                    return colorScale(d.total);
                });
        }

    </script>

    <!-- Footer -->
    <div class="footer">

    </div>

</body>

</html>

<!-- CSS definitions -->
<style>

    .sidepanel_headline{
        font-size: 23px;
        font-weight: bold;
    }

    .sidepanel_entry{
        font-size: 15px;
        font-weight: bold;
        text-align: left;
    }

    .country {
        fill: #ccc;
        stroke: #999;
    }

    .header {
        position: fixed;
        width: 100%;
        height: 40px;
        text-align: left;
        background-color: #eee;
    }

    .map {
        padding-top: 40px;
        padding-left: 100px;
    }

    .settings {
        font-weight: bold;
        padding: 0.5rem;
        border: 1px solid silver;
        width: 100%;
        height: 20px;
    }

    .sidenav {
        width: 250px;
        position: fixed;
        top: 100px;
        left: 20px;
        background: #7c7a78e7;
        border: 4px solid silver;
        padding: 8px 0;
        border-radius: 2%
    }


</style>