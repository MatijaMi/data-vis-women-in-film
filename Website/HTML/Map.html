<!DOCTYPE html>

<html lang="en" style="height: 100%">

<head>
    <title>WFPP</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../CSS/baseStyle.css">
    <link rel="sidepanel_css" href="../CSS/map_sidepanel.css">
    <script type="module" src="../JS/generalBehaviour.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

</head>

<body>

    <!-- Header -->
    <div class="header" id="header">
        <a href="/index.html">Home</a>
        <a href="Map.html">Map</a>
        <a href="Viewer.html">Viewer</a>
        <a href="">Extra</a>
        <a href="">Gallery</a>
        <a href="">About</a>
    </div>

    <!-- Sidepanel -->
    <div id="mySidepanel" class="sidepanel">
        <a href="javascript:void(0)" class="closebtn" id="sidePanelClose">&times;</a>

        <label>Settings</label>

        <br><br>

        <label for="FromYear">From:</label>
        <input type="number" id="from" name="from" min="1800" max="2020">
        <label for="ToYear">To:</label>
        <input type="number" id="to" name="to" min="1800" max="2020">

        <br><br>

        <input type="checkbox" id="checkbox1" name="checkbox1" value="checkbox1Checked">
        <label for="checkbox1">Only display top 10</label><br>

        <br>

        <input type="checkbox" id="checkbox2" name="checkbox2" value="checkbox2Checked">
        <label for="checkbox2">Show Connections</label><br>
    </div>

    <button id="sidepanel_button" class="openbtn">&#9776;</button>

    <!-- Map Object -->
    <div class="map" id="map_panel"></div>

    <!-- Map -->
    <script>

        // Dimensions
        var width = window.innerWidth;
        var height = window.innerHeight;

        // Append the svg object to the body of the page
        var svg = d3.select("#map_panel")
            .append("svg")
            .attr("width", width)
            .attr("height", height)

        // Map and projection
        var path = d3.geoPath();
        var projection = d3.geoMercator()
            .scale(70 * 3.5)
            .center([0, 0])
            .translate([width / 2, height / 1.5]);

        // Data and color scale
        var data = d3.map();
        var colorScale = d3.scaleThreshold()
            .domain([1, 2, 5, 15, 50, 100])
            .range(d3.schemeBlues[6]);

        // Load external data and boot
        d3.queue()
            .defer(d3.json, "../Data/world_map.geojson")
            .defer(d3.csv, "../Data/world_population.csv", function (d) { data.set(d.code, +d.pop); })
            .defer(d3.csv, "../Data/connections.csv")
            .await(ready);

        //Forces page to automaticly reloade margin of header
        scroll(0, 100)
        scroll(0, 0)

        function ready(error, map_data, population_data, connection_data) {


            //Calculate connections
            var link = []
            connection_data.forEach(function (row) {
                source = [+row.long1, +row.lat1]
                target = [+row.long2, +row.lat2]
                topush = { type: "LineString", coordinates: [source, target] }
                link.push(topush)

            })

            //Mouse Over
            let mouseOver = function (d) {
                d3.selectAll(".Country")
                    .transition()
                    .duration(200)
                    //.style("opacity", .5)
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("opacity", 1)
                    .style("stroke", "black")
            }

            let mouseLeave = function (d) {
                d3.selectAll(".Country")
                    .transition()
                    .duration(0)
                    .style("opacity", .8)
                d3.select(this)
                    .transition()
                    .duration(0)
                    .style("stroke", "transparent")
            }


            // Draw the map
            svg.append("g")
                .selectAll("path")
                .data(map_data.features)
                .enter()
                .append("path")

                // draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )

                .attr("class", function (d) { return "Country" })
                .style("opacity", .8)
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave)

                // set the color of each country
                .attr("fill", function (d) {
                    d.total = data.get(d.id) || 0;
                    return colorScale(d.total);
                });


            // Add the path
            svg.selectAll("myPath")
                .data(link)
                .enter()
                .append("path")
                .attr("d", function (d) { return path(d) })
                .style("fill", "none")
                .style("stroke", "#69b3a2")
                .style("stroke-width", 2)



        }


    </script>

    <!-- Footer -->
    <div class="footer">

    </div>

</body>

</html>

<style>
    .country {
        fill: #ccc;
        stroke: #999;
    }

    .header {
        position: fixed;
        width: 100%;
        height: 40px;
        text-align: left;
        background-color: #eee;
    }

    .map {
        padding-top: 40px;
    }
</style>