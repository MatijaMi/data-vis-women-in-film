<!DOCTYPE html>

<html lang="en" style="height: 100%">

<head>
    <title>WFPP</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../CSS/baseStyle.css">
    <link rel="stylesheet" href="../CSS/map.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://github.com/typeiii/jquery-csv"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="../JS/map.js"></script>

</head>

<body>

    <!-- Header -->
    <div class="header" id="header">
        <a href="/index.html">Home</a>
        <a href="Map.html">Map</a>
        <a href="Viewer.html">Viewer</a>
        <a href="">Extra</a>
        <a href="">Gallery</a>
        <a href="">About</a>
    </div>

    <!-- Sidepanel -->
    <div class="sidepanel_panel">

        <label class="headline" id="country_name_label"></label>

        <br><br>

        <div id="sidepanel_holder" hidden="true">

            <label class="text_short">Pioneers: </label>
            <label class="text_short" id="pioneers_count_label"></label><br>

            <label class="text_short">Different Jobs: </label>
            <label class="text_short" id="pioneers_jobs_label"></label><br>

            <label class="text_short">Connections: </label>
            <label class="text_short" id="pioneers_connections_label"></label>

            <br><br>

            <label class="text_short">Example Pioneer: </label><br>
            <label class="text_short" id="pioneers_ex_name"></label>

            <br><br>

            <img class="sidepanel_image" id="pioneers_ex_image"
                src="https://wfpp.columbia.edu/wp-content/uploads/2018/05/adaalineurban.jpg"
                onerror="image_load_error()">

            <br><br>

            <button class="round_button" id="pioneers_read_more_button">Read more</button>
            <button class="round_button" id="pioneers_next_button">Next</button>

        </div>
        <div class="text_long" id="sidepanel_empty_text" hidden="true">
            There are no pioneers registered to the WFFP between the selected Years. <br><br>
            If you want to contribute to the project please click the button below.
            <br><br>            
        </div>

        <button class="round_button" onclick="window.open('https://wfpp.columbia.edu/contribute/')" id="pioneers_contribute_button" hidden="true">Contribute</button>
    </div>

    <!-- Settings -->
    <div class="settings_panel">
        <label class="headline">Settings</label>

        <br><br>

        <input type="checkbox" class="largerCheckbox" id="settings_checkbox_unknown" onclick="load_data()" checked>
        <label class="text_long">Include Unknown Dates</label>

        <br><br>

        <button class="round_button" id="all_connections_button">Show all Connections</button>

        <br><br>

        <button class="round_button" id="switch_color_button" onclick="change_color()" checked>Change Color</button>

        <br><br>

    </div>

    <!-- Map Object -->
    <div class="map_holder">
        <div class="map_body" id="map_body"></div>
    </div>

    <!-- Slider -->
    <div class="slider-text-holder">
        <input type="text" id="amount" readonly
            style="border:0; color:#1fb9f6; font-weight:bold; text-align: center; font-size: 24px; pointer-events: none; width:150px"></input>
    </div>

    <div class="slider-holder">
        <div id="slider-range"></div>
    </div>

    <!-- Footer -->
    <div class="footer"></div>

    <!-- Map -->
    <script>

        //Slider
        var sliderWasUsed = false;
        var lastCountry = null;
        $(function () {
            $("#slider-range").slider({
                range: true,
                min: 1830,
                max: 2000,
                values: [1830, 2000],
                change: function (event, ui) {
                    load_data();
                    sliderWasUsed = true;
                },
                slide: function (event, ui) {
                    $("#amount").val(ui.values[0] + " - " + ui.values[1]);
                }

            });

            $("#amount").val($("#slider-range").slider("values", 0) +
                " - " + $("#slider-range").slider("values", 1));

        });

        //List of all countries
        var countries = createAllCountries();

        // Dimensions
        var width = window.innerWidth;
        var height = window.innerHeight;

        // Append the svg object to the body of the page
        var svg = d3.select("#map_body")
            .append("svg")
            .attr("width", width / 1.11)
            .attr("height", height / 1.01)

        // Map and projection
        var path = d3.geoPath();
        var projection = d3.geoMercator()
            .scale(245)
            .center([0, 0])
            .translate([width / 2, height / 1.5]);

        // Data
        var data = d3.map();

        // Load external data and boot
        load_data();


        function ready(error, map_data, complete_data) {

            document.getElementById('all_connections_button').onclick = function () { show_all_connections(countries) };

            //Mouse Over
            let mouseOver = function (d) {

                //Mouser Over Animation               
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("stroke", "black");

            }

            let mouseLeave = function (d) {

                //Mouser Leave Animation
                d3.select(this)
                    .transition()
                    .duration(0)
                    .style("stroke", "transparent")
            }

            let mouseClick = function (d) {

                //Set last country if slider will be used
                lastCountry = d;

                //Get current country
                var curr_country = findObjectByKey(countries, "country_code", d.id);

                //Check if country is used   
                if (findObjectByKey(countries, "country_code", d.id) == null || findObjectByKey(countries, "country_code", d.id).country_pioneers.length == 0) {
                    document.getElementById('country_name_label').innerHTML = d.properties.name;
                    document.getElementById('sidepanel_holder').hidden = true;
                    document.getElementById('sidepanel_empty_text').hidden = false;
                    document.getElementById('pioneers_contribute_button').hidden = false;
                    svg.selectAll(".Link").remove();
                    return;
                }
                else {
                    document.getElementById('sidepanel_empty_text').hidden = true;
                    document.getElementById('pioneers_contribute_button').hidden = true;
                }

                //Remove old links
                svg.selectAll(".Link").remove();


                //Sidebar                
                document.getElementById('country_name_label').innerHTML = curr_country.country_name;
                document.getElementById('pioneers_count_label').innerHTML = curr_country.country_pioneers.length;
                document.getElementById('pioneers_jobs_label').innerHTML = curr_country.country_jobs.length;
                document.getElementById('pioneers_connections_label').innerHTML = curr_country.country_connected_countries.length;

                show_example_pioneer(curr_country.country_pioneers);

                document.getElementById('sidepanel_holder').hidden = false;

                //Calculate connections
                var link = []
                for (var i = 0; i < curr_country.country_connected_countries.length; i++) {
                    var connected_country = findObjectByKey(countries, "country_name", curr_country.country_connected_countries[i]);

                    source = [curr_country.country_long, curr_country.country_lat]
                    target = [connected_country.country_long, connected_country.country_lat]
                    topush = { type: "LineString", coordinates: [source, target] }
                    link.push(topush)
                }

                // Add the path
                svg.selectAll("myPath")
                    .data(link)
                    .enter()
                    .append("path")
                    .attr("d", function (d) { return path(d) })
                    .attr("class", function (d) { return "Link" })
                    .style("pointer-events", "none")
                    .style("fill", "none")
                    .style("stroke", "#00d4db")
                    .style("stroke-width", 4)
                    .style("opacity", 0)
                    .transition()
                    .duration(500)
                    .style("opacity", 1)

            }

            //Draw the map
            svg.selectAll("path").remove();

            svg.append("g")
                .selectAll("path")
                .data(map_data.features)
                .enter()
                .append("path")

                //Draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )

                .attr("class", function (d) { return "Country" })
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave)
                .on("click", mouseClick)


                //Set the color of each country
                .attr("fill", function (d) {

                    var colorScale = get_color_scale();

                    if (findObjectByKey(countries, "country_code", d.id) != null) {
                        return colorScale(findObjectByKey(countries, "country_code", d.id).country_pioneers.length);
                    }
                    else return colorScale(0);

                });

            //Reset UI
            if (sliderWasUsed && lastCountry !== null) {
                mouseClick(lastCountry);
            }
        }

    </script>

</body>

</html>